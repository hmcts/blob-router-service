<policies>
  <backend>
    <base/>
  </backend>
  <inbound>
    <base/>
    <send-request mode="new" response-variable-name="apiKeySecret" timeout="20" ignore-error="false">
      <set-url>https://reform-scan-{ENV_NAME}.vault.azure.net/secrets/reconciliation-api-key/?api-version=7.0</set-url>
      <set-method>GET</set-method>
      <authentication-managed-identity resource="https://vault.azure.net" />
    </send-request>
    <!-- transform keyvault secret response to string -->
    <set-variable name="apiKeySecretResponse" value="@{
            var secret = ((IResponse)context.Variables["apiKeySecret"]).Body.As<JObject>();
            return secret["value"].ToString();
        }" />

    <set-header name="Authorization" exists-action="override">
      <value>@("Bearer " + (string)context.Variables["apiKeySecretResponse"])</value>
    </set-header>

  </inbound>
  <outbound>
    <base/>
  </outbound>
  <on-error>
    <base/>
  </on-error>
</policies>
